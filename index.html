<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© Ø­Ø¯ÙŠØ«Ø© ÙˆØ®Ø· Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø¹Ø±Ø¶ */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
        
        /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø³Ø§Ø³ÙŠØ© */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø«ÙŠÙ… Telegram */
            --tg-bg: var(--tg-theme-bg-color, #f4f4f4);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #888888);
            --tg-link: var(--tg-theme-link-color, #007bff);
            --tg-btn-bg: var(--tg-theme-button-color, #0088cc);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --shib-color: #f0c33a; /* Ù„ÙˆÙ† Ø§Ù„Ø´ÙŠØ¨Ø§ */
            --shib-dark: #cc9c1c;
        }

        body {
            font-family: 'Vazirmatn', Arial, sans-serif;
            background: var(--tg-bg);
            color: var(--tg-text);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: right;
            direction: rtl;
            user-select: none;
            overflow-x: hidden;
        }

        /* ----------------------------------------------------- */
        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (3D Style) */
        /* ----------------------------------------------------- */
        .stats-grid {
            width: 100%;
            max-width: 450px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tg-bg);
            border-radius: 18px;
            padding: 15px;
            text-align: center;
            /* ØªØ£Ø«ÙŠØ± 3D (Ø¸Ù„ Ø¯Ø§Ø®Ù„ÙŠ ÙˆØ®Ø§Ø±Ø¬ÙŠ Ø®ÙÙŠÙ Ù…Ø¹ Ø­Ø§ÙØ©) */
            box-shadow: 
                -5px -5px 10px rgba(255, 255, 255, 0.5), /* Ø¸Ù„ Ø¹Ù„ÙˆÙŠ/Ø£ÙŠØ³Ø± ÙØ§ØªØ­ */
                5px 5px 10px rgba(0, 0, 0, 0.15), /* Ø¸Ù„ Ø³ÙÙ„ÙŠ/Ø£ÙŠÙ…Ù† Ø¯Ø§ÙƒÙ† */
                inset 1px 1px 3px rgba(255, 255, 255, 0.6), /* Ø¥Ø¶Ø§Ø¡Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
                inset -1px -1px 3px rgba(0, 0, 0, 0.1); /* Ø¸Ù„ Ø¯Ø§Ø®Ù„ÙŠ */
            transition: transform 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.05); /* Ø­Ø§ÙØ© Ø®ÙÙŠÙØ© */
            min-height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--tg-hint);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            color: var(--shib-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card.balance p {
             font-size: 28px;
        }

        /* ----------------------------------------------------- */
        /* Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Actions Section) */
        /* ----------------------------------------------------- */
        .actions-container {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† */
        .watch-ad-btn {
            background: linear-gradient(145deg, #17d457, #13b349); /* ØªØ¯Ø±Ø¬ Ø£Ø®Ø¶Ø± Ø¬Ø°Ø§Ø¨ */
            color: white;
            font-weight: 800;
            font-size: 18px;
            padding: 15px 20px;
        }
        
        /* Ø²Ø± Ø§Ù„Ø³Ø¨ÙŠÙ† ÙˆØ§Ù„Ø³Ø­Ø¨ */
        .spin-withdraw-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .spin-btn {
            background: linear-gradient(145deg, #ffc107, #e0a800); /* ØªØ¯Ø±Ø¬ Ø£ØµÙØ± Ù„Ù„Ø³Ø¨ÙŠÙ† */
            color: #333;
            font-weight: 800;
            font-size: 16px;
        }
        
        .withdraw-btn {
            background: linear-gradient(145deg, #00bcd4, #0097a7); /* ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ Ù„Ù„Ø³Ø­Ø¨ */
            color: white;
            font-weight: 800;
            font-size: 16px;
        }
        
        .task-btn {
            background: linear-gradient(145deg, #9932cc, #800080); /* ØªØ¯Ø±Ø¬ Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ù…Ù‡Ù…Ø© */
            color: white;
            font-weight: 800;
            font-size: 18px;
            padding: 15px 20px;
        }

        /* ----------------------------------------------------- */
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± (Button 3D Style) */
        /* ----------------------------------------------------- */
        .app-btn {
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s ease;
            box-shadow: 
                0 6px 0 var(--shib-dark), /* Ø§Ù„Ø¸Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø·ÙŠ ØªØ£Ø«ÙŠØ± 3D */
                0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ…/Ø§Ù„Ù†Ù‚Ø±: ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· */
        .app-btn:active {
            transform: translateY(3px);
            box-shadow: 
                0 3px 0 var(--shib-dark),
                0 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .watch-ad-btn.app-btn {
            box-shadow: 0 6px 0 #0f7935; /* Ø¸Ù„ Ø£Ø®Ø¶Ø± Ø£ØºÙ…Ù‚ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† */
        }
        .watch-ad-btn.app-btn:active {
            box-shadow: 0 3px 0 #0f7935;
        }

        .spin-btn.app-btn {
            box-shadow: 0 6px 0 #a98500; /* Ø¸Ù„ Ø£ØµÙØ± Ø£ØºÙ…Ù‚ Ù„Ù„Ø³Ø¨ÙŠÙ† */
            color: #333;
        }
        .spin-btn.app-btn:active {
            box-shadow: 0 3px 0 #a98500;
        }
        
        .withdraw-btn.app-btn {
            box-shadow: 0 6px 0 #005a63; /* Ø¸Ù„ Ø£Ø²Ø±Ù‚ Ø£ØºÙ…Ù‚ Ù„Ù„Ø³Ø­Ø¨ */
        }
        .withdraw-btn.app-btn:active {
            box-shadow: 0 3px 0 #005a63;
        }
        
        .task-btn.app-btn {
            box-shadow: 0 6px 0 #5b0f5b; /* Ø¸Ù„ Ø¨Ù†ÙØ³Ø¬ÙŠ Ø£ØºÙ…Ù‚ Ù„Ù„Ù…Ù‡Ù…Ø© */
        }
        .task-btn.app-btn:active {
            box-shadow: 0 3px 0 #5b0f5b;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù/Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ */
        .app-btn:disabled, .app-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ----------------------------------------------------- */
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø£Ø®Ø±Ù‰ */
        /* ----------------------------------------------------- */
        .header {
            width: 100%;
            max-width: 450px;
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
            font-weight: 900;
        }
        
        .header h1 {
             font-size: 26px;
             color: var(--shib-color);
             text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .footer-note {
             font-size: 12px;
             color: var(--tg-hint);
             margin-top: 15px;
             max-width: 450px;
             text-align: center;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
        .alert {
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            font-weight: 700;
            display: none; /* ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¨Ø§Ù„Ù€ JS */
        }
        
        /* Modal - Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø­Ø¨ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--tg-bg);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content h2 {
            color: var(--tg-text);
            margin-bottom: 20px;
            font-weight: 900;
        }
        
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--tg-hint);
            border-radius: 8px;
            background: var(--tg-bg);
            color: var(--tg-text);
            text-align: right;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 16px;
            font-weight: 700;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content button {
            width: 100%;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            color: var(--tg-hint);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Loader) */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loader {
            border: 4px solid var(--tg-hint);
            border-top: 4px solid var(--shib-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <div id="loader" class="loader-overlay">
        <div class="loader"></div>
    </div>
    
    <div id="mainApp" style="display: none; width: 100%; align-items: center; flex-direction: column;">
        
        <div class="header">
            <h1>SHIBA INU EARNING</h1>
            <p id="userNameDisplay" style="font-size: 14px; font-weight: 700; color: var(--tg-hint);"></p>
        </div>

        <div class="stats-grid">
            <div class="stat-card balance" style="grid-column: 1 / 3;">
                <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (SHIB)</h3>
                <p id="userBalance">0</p>
            </div>
            <div class="stat-card">
                <h3>ğŸ“º Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <p id="adsWatched">0 / 100</p>
            </div>
            <div class="stat-card">
                <h3>ğŸ¡ Ø³Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</h3>
                <p id="spinsToday">0 / 15</p>
            </div>
        </div>

        <div class="actions-container">
            
            <button class="app-btn watch-ad-btn" id="watchAdBtn" onclick="handleWatchAdClick()">
                ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† (+3 SHIB)
            </button>
            
            <div class="spin-withdraw-grid">
                <button class="app-btn spin-btn" id="spinBtn" onclick="handleSpinClick()">
                    ğŸ¡ Ø³Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¸
                </button>
                <button class="app-btn withdraw-btn" id="withdrawBtn" onclick="openWithdrawModal()">
                    ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
                </button>
            </div>
            
            <button class="app-btn task-btn" id="completeTaskBtn" onclick="handleCompleteTaskClick()">
                ğŸ Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© (+50 SHIB)
            </button>
        </div>
        
        <p class="footer-note">
            ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª Ù…Ù† Ù„Ø­Ø¸Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰.
        </p>
    </div>
    
    <div id="withdrawModal" class="modal" onclick="if(event.target.id === 'withdrawModal') closeWithdrawModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closeWithdrawModal()">&times;</span>
            <h2>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h2>
            <p style="font-size: 14px; margin-bottom: 10px; color: var(--tg-link); font-weight: 700;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 400 SHIB</p>
            <input type="number" id="withdrawAmount" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ (SHIB)" value="400">
            <input type="text" id="binanceId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Binance Pay ID/UID">
            <button class="app-btn withdraw-btn" style="width: 100%;" onclick="handleWithdraw()">
                ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨
            </button>
        </div>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        tg.expand();
        tg.MainButton.hide();

        const API_URL = '/api'; // Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ù…Ù„Ù index.js ÙÙŠ Vercel
        const ADMIN_USER_ID = '7741750541'; // âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ ÙŠØ·Ø§Ø¨Ù‚ ID Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ index.js
        
        let userData = {
            balance: 0,
            ads_watched_today: 0,
            spins_today: 0,
            is_banned: false,
            task_completed: false
        };
        
        let lastActionTime = 0; // Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Rate Limit)
        const RATE_LIMIT_MS = 3000; // 3 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª

        const adminUserId = ADMIN_USER_ID;

        // ----------------- Helper Functions -----------------
        
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }
        
        function showCustomAlert(title, message, type) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙŠØ²Ø© WebApp.showAlert Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
            tg.showAlert(message);
        }

        async function fetchApi(body) {
            showLoader(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ...body, 
                        initData: tg.initData,
                        user_id: tg.initDataUnsafe.user.id.toString() 
                    }),
                });

                const data = await response.json();
                showLoader(false);
                
                if (!response.ok || !data.ok) {
                    const errorMessage = data.error || data.message || `API Error: ${response.statusText}`;
                    showCustomAlert('Ø®Ø·Ø£', errorMessage, 'error');
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    if (data.is_banned) {
                        userData.is_banned = true;
                        updateUI();
                    }
                    return null;
                }
                
                return data.data;

            } catch (error) {
                console.error('Fetch API Error:', error);
                showLoader(false);
                showCustomAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.', 'error');
                return null;
            }
        }
        
        /**
         * Ø·Ù„Ø¨ Action ID Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
         */
        async function requestActionId(action_type) {
             const result = await fetchApi({
                type: 'generateActionId',
                action_type: action_type
            });
            return result ? result.action_id : null;
        }

        // ----------------- UI Updates -----------------
        
        function updateUI() {
            if (userData.is_banned) {
                document.getElementById('mainApp').innerHTML = `
                    <div class="header" style="margin-top: 50px;">
                        <h1>ğŸš« ØªÙ… Ø­Ø¸Ø±Ùƒ!</h1>
                        <p style="color: #dc3545; font-size: 18px; font-weight: 700;">Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</p>
                    </div>
                `;
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('userBalance').textContent = Math.floor(userData.balance).toLocaleString('en-US');
            document.getElementById('adsWatched').textContent = `${userData.ads_watched_today.toLocaleString('en-US')} / 100`;
            document.getElementById('spinsToday').textContent = `${userData.spins_today.toLocaleString('en-US')} / 15`;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            const watchAdBtn = document.getElementById('watchAdBtn');
            const spinBtn = document.getElementById('spinBtn');
            const withdrawBtn = document.getElementById('withdrawBtn');
            const taskBtn = document.getElementById('completeTaskBtn');
            
            // 1. Ø²Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            if (userData.ads_watched_today >= 100) {
                watchAdBtn.textContent = 'â±ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØµÙ„ (Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©)';
                watchAdBtn.disabled = true;
            } else {
                 watchAdBtn.textContent = 'ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† (+3 SHIB)';
                 watchAdBtn.disabled = false;
            }
            
            // 2. Ø²Ø± Ø§Ù„Ø³Ø¨ÙŠÙ†
            if (userData.spins_today >= 15) {
                spinBtn.textContent = 'â±ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø³Ø¨ÙŠÙ† ÙˆØµÙ„';
                spinBtn.disabled = true;
            } else {
                spinBtn.textContent = 'ğŸ¡ Ø³Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¸';
                spinBtn.disabled = false;
            }
            
            // 3. Ø²Ø± Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 400)
            withdrawBtn.disabled = userData.balance < 400;
            
            // 4. Ø²Ø± Ø§Ù„Ù…Ù‡Ù…Ø©
            if (userData.task_completed) {
                taskBtn.textContent = 'âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©';
                taskBtn.disabled = true;
                taskBtn.style.opacity = 0.8;
                taskBtn.style.pointerEvents = 'none';
            } else {
                taskBtn.textContent = 'ğŸ Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© (+50 SHIB)';
                taskBtn.disabled = false;
                taskBtn.style.opacity = 1;
                taskBtn.style.pointerEvents = 'auto';
            }
            
            // Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
            if (tg.initDataUnsafe.user.id.toString() === adminUserId) {
                 if (!document.getElementById('adminLink')) {
                    const adminLink = document.createElement('a');
                    adminLink.id = 'adminLink';
                    adminLink.href = 'admin.html'; // âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ù…ÙŠØ© Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ admin.html
                    adminLink.textContent = 'ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';
                    adminLink.style.cssText = 'display:block; margin-top: 15px; font-weight: 700; color: var(--tg-link);';
                    document.getElementById('mainApp').appendChild(adminLink);
                 }
            }
        }

        // ----------------- Core Functions -----------------
        
        async function loadUserData(ref_by = null) {
            const user = tg.initDataUnsafe.user;
            document.getElementById('userNameDisplay').textContent = `@${user.username || user.first_name}`;
            
            const registerData = await fetchApi({ 
                type: 'register', 
                ref_by: ref_by,
                username: user.username,
                first_name: user.first_name
            });
            
            if (!registerData) {
                showLoader(false);
                return;
            }

            const data = await fetchApi({ type: 'getUserData' });
            
            if (data) {
                userData = {
                    balance: data.balance || 0,
                    ads_watched_today: data.ads_watched_today || 0,
                    spins_today: data.spins_today || 0,
                    is_banned: data.is_banned || false,
                    task_completed: data.task_completed || false
                };
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('mainApp').style.display = 'flex';
            showLoader(false);
            updateUI();
        }
        
        
        // ----------------- Action Handlers -----------------

        /**
         * Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
         */
        async function handleWatchAdClick() {
            const now = Date.now();
            if (now - lastActionTime < RATE_LIMIT_MS) {
                showCustomAlert('Ù…Ù‡Ù„Ø§Ù‹!', 'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†Ù Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.', 'warning');
                return;
            }
            lastActionTime = now;
            
            // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Action ID
            const actionId = await requestActionId('watchAd');
            if (!actionId) return;

            // 2. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ¹Ù„ÙŠ)
            showLoader(true);
            await new Promise(resolve => setTimeout(resolve, 2500)); // Ø§Ù†ØªØ¸Ø§Ø± 2.5 Ø«Ø§Ù†ÙŠØ©
            showLoader(false);

            // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø®Ù„ÙÙŠØ©
            const result = await fetchApi({ 
                type: 'watchAd', 
                action_id: actionId 
            });
            
            if (result) {
                userData.balance = result.new_balance;
                userData.ads_watched_today = result.new_ads_count;
                showCustomAlert('Ù†Ø¬Ø§Ø­!', `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${result.actual_reward} SHIB Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ.`, 'success');
                updateUI();
            }
        }
        
        /**
         * Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø³Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¸
         */
        async function handleSpinClick() {
             const now = Date.now();
            if (now - lastActionTime < RATE_LIMIT_MS) {
                showCustomAlert('Ù…Ù‡Ù„Ø§Ù‹!', 'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†Ù Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.', 'warning');
                return;
            }
            lastActionTime = now;
            
            // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Action ID Ù„Ù€ preSpin
            const preSpinActionId = await requestActionId('preSpin');
            if (!preSpinActionId) return;
            
            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ preSpin (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø­Ø¸Ø± Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„)
            const preSpinResult = await fetchApi({ 
                type: 'preSpin', 
                action_id: preSpinActionId 
            });
            
            if (!preSpinResult) return;
            
            // 3. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Action ID Ù„Ù€ spinResult
            const spinResultActionId = await requestActionId('spinResult');
            if (!spinResultActionId) return;

            // 4. Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø¨ÙŠÙ† (3 Ø«ÙˆØ§Ù†ÙŠ)
            showLoader(true);
            await new Promise(resolve => setTimeout(resolve, 3000)); 
            
            // 5. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const result = await fetchApi({ 
                type: 'spinResult', 
                action_id: spinResultActionId 
            });
            
            if (result) {
                userData.balance = result.new_balance;
                userData.spins_today = result.new_spins_count;
                showCustomAlert('ÙÙˆØ²!', `ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ÙØ²Øª Ø¨Ù€ ${result.actual_prize} SHIB.`, 'success');
                updateUI();
            }
        }
        
        /**
         * ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø­Ø¨
         */
        function openWithdrawModal() {
            if (userData.balance < 400) {
                 showCustomAlert('Ø®Ø·Ø£', 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ 400 SHIB.', 'error');
                 return;
            }
            document.getElementById('withdrawAmount').value = Math.floor(userData.balance);
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        /**
         * Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø­Ø¨
         */
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'none';
        }
        
        /**
         * Ù…Ø¹Ø§Ù„Ø¬ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨
         */
        async function handleWithdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            const binanceId = document.getElementById('binanceId').value;
            const withdrawalAmount = parseFloat(amount);
            
            if (isNaN(withdrawalAmount) || withdrawalAmount < 400) {
                showCustomAlert('Ø®Ø·Ø£', 'Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 400 SHIB.', 'error');
                return;
            }
            if (!binanceId.trim()) {
                showCustomAlert('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Binance Pay ID Ø£Ùˆ UID.', 'error');
                return;
            }
            
            if (withdrawalAmount > userData.balance) {
                showCustomAlert('Ø®Ø·Ø£', 'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ.', 'error');
                return;
            }
            
            closeWithdrawModal();
            
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            const result = await fetchApi({
                type: 'withdraw',
                amount: withdrawalAmount,
                binanceId: binanceId,
                action_id: actionId
            });

            if (result) {
                userData.balance = result.new_balance;
                showCustomAlert('Ù†Ø¬Ø§Ø­!', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.', 'success');
                updateUI();
            }
        }
        
        /**
         * Ù…Ø¹Ø§Ù„Ø¬ Ù…Ù‡Ù…Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©
         */
        async function handleCompleteTaskClick() {
            if (userData.task_completed) {
                 showCustomAlert('Ù…Ù‡Ù„Ø§Ù‹!', 'Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„.', 'warning');
                 return;
            }
            
            const now = Date.now();
            if (now - lastActionTime < RATE_LIMIT_MS) {
                showCustomAlert('Ù…Ù‡Ù„Ø§Ù‹!', 'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†Ù Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.', 'warning');
                return;
            }
            lastActionTime = now;
            
            tg.showConfirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ù‡Ù…Ø©', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø§Ù†Ø¶Ù…Ù…Øª Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŸ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¶ÙˆÙŠØªÙƒ.', async (confirmed) => {
                if (confirmed) {
                    const actionId = await requestActionId('completeTask');
                    if (!actionId) return;

                    const result = await fetchApi({ 
                        type: 'completeTask', 
                        action_id: actionId 
                    });
                    
                    if (result) {
                        userData.balance = result.new_balance;
                        userData.task_completed = true;
                        showCustomAlert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!', `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${result.actual_reward} SHIB ÙƒÙ…ÙƒØ§ÙØ£Ø© Ù…Ù‡Ù…Ø©.`, 'success');
                        updateUI();
                    }
                }
            });
        }

        // ----------------- Initialization -----------------
        
        window.onload = function() {
            if (tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                let ref_by = null;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙØ­ÙŠÙ„ ÙÙŠ start_param
                const startParam = new URLSearchParams(tg.initData).get('start_param');
                if (startParam) {
                    const refMatch = startParam.match(/^ref(\d+)$/);
                    if (refMatch && refMatch[1] !== user.id.toString()) {
                        ref_by = refMatch[1];
                    }
                }
                
                loadUserData(ref_by);
            } else {
                showLoader(false);
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('mainApp').innerHTML = `
                    <div class="header" style="margin-top: 50px;">
                        <h1>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h1>
                        <p style="color: #dc3545; font-size: 18px; font-weight: 700;">ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Telegram.</p>
                    </div>
                `;
            }
        };

    </script>
</body>
</html>